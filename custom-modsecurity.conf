# Custom ModSecurity Rules
# Дополнительные правила для защиты веб-приложения

# -- Whitelist правила для российских сайтов ---------------------------------

# Разрешить кириллические символы в параметрах
SecRule ARGS "@detectXSS" \
    "id:999001,\
    phase:2,\
    block,\
    t:none,t:urlDecodeUni,t:htmlEntityDecode,t:replaceNulls,t:js_decode,\
    msg:'XSS Attack Detected (Cyrillic safe)',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    severity:2,\
    tag:'attack-xss',\
    ctl:ruleRemoveByTag=attack-xss"

# -- Настройки для российского контента --------------------------------------

# Исключения для кириллицы
SecRuleRemoveById 920273

# Блокировка подозрительных User-Agent
SecRule REQUEST_HEADERS:User-Agent "@pmFromFile /etc/nginx/conf.d/bad-user-agents.txt" \
    "id:999100,\
    phase:1,\
    deny,\
    status:403,\
    msg:'Malicious User Agent Detected',\
    logdata:'User-Agent: %{matched_var}',\
    severity:2,\
    tag:'attack-protocol'"

# -- Защита от брутфорса ----------------------------------------------------

# Ограничение количества POST запросов
SecRule REQUEST_METHOD "@streq POST" \
    "id:999200,\
    phase:1,\
    pass,\
    nolog,\
    initcol:ip=%{remote_addr},\
    setvar:ip.post_count=+1,\
    expirevar:ip.post_count=60"

SecRule IP:POST_COUNT "@gt 20" \
    "id:999201,\
    phase:1,\
    deny,\
    status:429,\
    msg:'POST request rate limit exceeded',\
    logdata:'IP: %{remote_addr}, Count: %{ip.post_count}',\
    severity:2"

# -- Защита административных путей ------------------------------------------

# Блокировка доступа к административным панелям
SecRule REQUEST_URI "@beginsWith /admin" \
    "id:999300,\
    phase:1,\
    deny,\
    status:404,\
    msg:'Access to admin panel blocked',\
    severity:2,\
    tag:'admin-access'"

# Исключение для разрешенных IP (замените на свои IP адреса)
SecRule REMOTE_ADDR "@ipMatch 127.0.0.1,::1" \
    "id:999301,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=999300"

# -- Защита от SQL инъекций (дополнительно) ---------------------------------

# Блокировка популярных SQL команд в параметрах
SecRule ARGS "@detectSQLi" \
    "id:999400,\
    phase:2,\
    deny,\
    status:403,\
    msg:'SQL Injection Attack Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    severity:2,\
    tag:'attack-sqli'"

# -- Защита от загрузки вредоносных файлов -----------------------------------

# Блокировка загрузки опасных типов файлов
SecRule FILES_NAMES "@rx \.(php|php3|php4|php5|phtml|pht|asp|aspx|jsp|cgi|pl|py|rb|sh|bat|cmd|exe|scr|vbs|jar)$" \
    "id:999500,\
    phase:2,\
    deny,\
    status:403,\
    msg:'Dangerous file type upload blocked',\
    logdata:'File: %{MATCHED_VAR}',\
    severity:2,\
    tag:'attack-file-upload'"

# -- Геоблокировка (опционально) --------------------------------------------

# Разрешить только российские и СНГ IP адреса (раскомментируйте если нужно)
# SecGeoLookupDb /usr/share/GeoIP/GeoIP.dat
# SecRule REMOTE_ADDR "@geoLookup" "phase:1,id:999600,nolog,pass,setvar:tx.country_code=%{geo.country_code}"
# SecRule TX:COUNTRY_CODE "!@rx ^(RU|BY|KZ|UA|AM|AZ|GE|KG|MD|TJ|TM|UZ)$" \
#     "id:999601,\
#     phase:1,\
#     deny,\
#     status:403,\
#     msg:'Access denied from country: %{tx.country_code}',\
#     severity:2"

# -- Кастомные правила для конкретного приложения ----------------------------

# Защита от спама в комментариях
SecRule ARGS:comment "@pmFromFile /etc/nginx/conf.d/spam-keywords.txt" \
    "id:999700,\
    phase:2,\
    deny,\
    status:403,\
    msg:'Spam content detected in comment',\
    severity:2,\
    tag:'spam'"

# Блокировка подозрительных поисковых запросов
SecRule ARGS:q|ARGS:query|ARGS:search "@rx (?i)(union|select|insert|delete|update|drop|create|alter|exec|script|javascript|vbscript|onload|onerror)" \
    "id:999701,\
    phase:2,\
    deny,\
    status:403,\
    msg:'Malicious search query detected',\
    logdata:'Query: %{MATCHED_VAR}',\
    severity:2"

# -- Мониторинг и логирование -----------------------------------------------

# Логирование всех заблокированных запросов
SecRule RESPONSE_STATUS "@rx ^(40[0-9]|50[0-9])$" \
    "id:999800,\
    phase:5,\
    pass,\
    nolog,\
    auditlog,\
    msg:'HTTP Error Response: %{response_status}'"

# -- Исключения для ложных срабатываний ------------------------------------

# Исключения для jQuery и других JS библиотек
SecRuleRemoveByMsg "@contains jquery"
SecRuleRemoveByMsg "@contains bootstrap"

# Исключения для статических ресурсов
SecRule REQUEST_URI "@rx \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$" \
    "id:999900,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleEngine=Off"

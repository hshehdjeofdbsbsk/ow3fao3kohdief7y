upstream app_server {
  server unix:/srv/fastapi-app/run/gunicorn.sock fail_timeout=0;
}
server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  ssl_certificate     /etc/letsencrypt/live/hp-fulfilment.ru/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/hp-fulfilment.ru/privkey.pem;
  include             /etc/letsencrypt/options-ssl-nginx.conf;
  ssl_dhparam         /etc/letsencrypt/ssl-dhparams.pem;
  server_name ~^(?!murmansk\.|www\.)[a-z0-9-]*\.?hp-fulfilment\.ru$;
  #error_log  /var/log/nginx/test.error.log;
  #access_log /var/log/nginx/test.access.log;
  #include /etc/nginx/bots-block.conf;
  #include /etc/nginx/geoip-block.conf;
  root /srv/rozarioflowers.ru/public;
  # https://www.phusionpassenger.com/library/config/nginx/reference/
  passenger_enabled on;
  passenger_user admin;
  passenger_ruby /home/admin/.asdf/shims/ruby;
  passenger_app_env development;
  location / {
    try_files $uri $uri/ @passenger;
  }
  location @passenger {
    passenger_enabled on;
    passenger_sticky_sessions on;
    passenger_base_uri /;
    passenger_app_root /srv/rozarioflowers.ru;
    passenger_document_root /srv/rozarioflowers.ru/public;
    # passenger_max_requests 666; # this feature is only available in Phusion Passenger Enterprise
    # passenger_memory_limit 256; # this feature is only available in Phusion Passenger Enterprise
    # passenger_max_request_time 10; # # this feature is only available in Phusion Passenger Enterprise
    passenger_min_instances 1;
  }
  location /api_variables {
    default_type text/html;
    return 200 "host: $host\nsubdomain: $subdomain\n";
  }
  location = /favicon.ico {
    access_log off;
    return 204;
  }
  location /api_nginx_status {
    passenger_enabled off;
    stub_status on;
    access_log off;
    # If you want to secure access to this virtual directory
    # allow 192.168.1.100; #Change this to your IP
    # Uncomment the next line if you want to allow access to this from anywhere
    allow all;
    # deny all;
  }
  location /error/ {
    alias /var/www/html/document_errors/;
  }
  location ~* ^.+\.(jpg|jpeg|gif|png|svg|js|css|mp3|ogg|mpe?g|avi|zip|gz|bz2?|rar|ico|js|json|html|bmp)$ {
    try_files $uri @passenger;
    access_log        off;
    expires           3d;
  }
  location ~ /\.(ht|svn|git|hg|bzr) { return 444; }
  location = /robots.txt  { rewrite ^/robots.txt$  /robots/$subdomain/robots.txt  break; }
  location = /sitemap.xml { rewrite ^/sitemap.xml$ /robots/$subdomain/sitemap.xml break; }
  location ^~ /fastapi/ {
    passenger_enabled off;
    keepalive_timeout 5;
    client_max_body_size 4G;
    access_log /srv/fastapi-app/log/nginx-access.log;
    error_log  /srv/fastapi-app/log/nginx-error.log;
    
    # Proxy cache settings
    proxy_cache cache;
    proxy_cache_valid 200 302 10m;
    proxy_cache_valid 404 1m;
    proxy_cache_bypass $no_cache;
    proxy_no_cache $no_cache;
    proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
    proxy_cache_lock on;
    proxy_cache_lock_timeout 5s;
    
    # Cache headers for debugging
    add_header X-Cache-Status $upstream_cache_status always;
    add_header X-Cache-Key "$host$request_uri" always;
    
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
    if (!-f $request_filename) {
      proxy_pass http://app_server;
      break;
    }
  }
}
